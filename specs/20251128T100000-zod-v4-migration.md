# Zod v4 Migration Specification

## Overview

This document provides a comprehensive handoff for migrating from Zod v3 (^3.25.67) to Zod v4 (4.1.x).

**Current version**: ^3.25.67
**Target version**: ^4.1.13

## Breaking Changes Summary

### 1. Error Customization (HIGH IMPACT)

The error customization API has been completely unified under a single `error` parameter.

#### `message` → `error`

```typescript
// Zod 3
z.string().min(5, { message: "Too short." });

// Zod 4
z.string().min(5, { error: "Too short." });
```

#### `invalid_type_error` and `required_error` removed

```typescript
// Zod 3
z.string({
  required_error: "This field is required",
  invalid_type_error: "Not a string",
});

// Zod 4
z.string({
  error: (issue) =>
    issue.input === undefined
      ? "This field is required"
      : "Not a string"
});
```

#### `errorMap` → `error`

```typescript
// Zod 3
z.string({
  errorMap: (issue, ctx) => {
    if (issue.code === "too_small") {
      return { message: `Value must be >${issue.minimum}` };
    }
    return { message: ctx.defaultError };
  },
});

// Zod 4
z.string().min(5, {
  error: (issue) => {
    if (issue.code === "too_small") {
      return `Value must be >${issue.minimum}`;
    }
  },
});
```

### 2. ZodError Changes (MEDIUM IMPACT)

| Zod 3 | Zod 4 | Notes |
|-------|-------|-------|
| `.format()` | `z.treeifyError()` | Deprecated |
| `.flatten()` | `z.treeifyError()` | Deprecated |
| `.formErrors` | Removed | Was undocumented alias |
| `.addIssue()` | Push to `err.issues` | Deprecated |

### 3. String Schema Changes (MEDIUM IMPACT)

```typescript
// Zod 3
z.string().email()
z.string().uuid()
z.string().ip()

// Zod 4
z.email()           // Top-level function
z.uuid()            // Stricter validation
z.ipv4() / z.ipv6() // Separate validators
```

### 4. Object Schema Changes (MEDIUM IMPACT)

| Zod 3 | Zod 4 | Notes |
|-------|-------|-------|
| `.strict()` | `z.strictObject()` | Top-level function |
| `.passthrough()` | `z.looseObject()` | Top-level function |
| `.strip()` | Default behavior | Removed |
| `.deepPartial()` | Removed | Not available |
| `.merge()` | `.extend()` | Deprecated |

### 5. Function Schema Changes (HIGH IMPACT)

```typescript
// Zod 3
const myFunc = z.function()
  .args(z.string())
  .returns(z.number())
  .implement((s) => s.length);

// Zod 4
const myFunc = z.function({
  input: z.tuple([z.string()]),
  output: z.number(),
}).implement((s) => s.length);
```

### 6. Other Breaking Changes

| Feature | Zod 3 | Zod 4 |
|---------|-------|-------|
| `z.nativeEnum()` | Supported | Use `z.enum()` instead |
| `z.promise()` | Supported | Deprecated; await before parsing |
| `z.coerce.*` input | Typed | Now `unknown` |
| `.refine()` type predicates | Narrow type | Ignored |
| `z.number().safe()` | Accepts floats | Same as `.int()` |
| `z.literal()` with symbols | Supported | Dropped |

## Migration Tasks

### Step 1: Find All Zod Usage

```bash
# Find all files using zod
grep -r "from 'zod'" --include="*.ts" --include="*.svelte" .
grep -r 'from "zod"' --include="*.ts" --include="*.svelte" .

# Find specific patterns to update
grep -r "\.email()" --include="*.ts" .
grep -r "message:" --include="*.ts" .
grep -r "errorMap" --include="*.ts" .
grep -r "z\.function()" --include="*.ts" .
```

### Step 2: Update Error Messages

Search for:
- `{ message:` → Replace with `{ error:`
- `invalid_type_error` → Replace with function-based `error`
- `required_error` → Replace with function-based `error`

### Step 3: Update String Validators

Search for:
- `.email()` → Consider using top-level `z.email()`
- `.uuid()` → Review for stricter validation
- `.ip()` → Replace with `z.ipv4()` or `z.ipv6()`

### Step 4: Update Object Methods

Search for:
- `.strict()` → Replace with `z.strictObject()`
- `.passthrough()` → Replace with `z.looseObject()`
- `.deepPartial()` → Refactor to avoid
- `.merge()` → Replace with `.extend()`

### Step 5: Update Error Handling

Search for:
- `.format()` → Replace with `z.treeifyError()`
- `.flatten()` → Replace with `z.treeifyError()`
- `.addIssue()` → Push to `err.issues` array

### Step 6: Update Function Schemas

Any usage of `z.function().args().returns()` needs complete refactoring.

### Step 7: Test Thoroughly

- Run full test suite
- Test all form validations
- Test all API request/response validations
- Test error message display

## Files Likely Affected

Based on typical Zod usage patterns, check:

- `apps/whispering/src/lib/` - Main app validation
- `packages/shared/` - Shared schemas
- `packages/db/` - Database schemas
- Any form components
- Any API route handlers

## Recommended Approach

1. **Create a feature branch** for the migration
2. **Update incrementally** by file/feature
3. **Run type checks frequently** to catch issues early
4. **Test each component** after updating
5. **Consider codemods** for mechanical replacements

## Resources

- [Zod v4 Migration Guide](https://zod.dev/v4-migration)
- [Zod v4 Changelog](https://github.com/colinhacks/zod/releases)

## Timeline Estimate

- **Small codebase**: 1-2 hours
- **Medium codebase**: 4-8 hours
- **Large codebase with complex schemas**: 1-2 days

The actual time depends on:
- Number of schemas using deprecated features
- Complexity of error customization
- Usage of `z.function()` schemas
- Test coverage to validate changes

## Review Notes

### Migration Completed: 2025-11-28

**Changes Made:**

1. **Updated Zod version** in `package.json` catalog:
   - From: `"zod": "^3.25.67"`
   - To: `"zod": "^4.1.13"`

2. **Updated `z.ZodTypeAny` to `z.ZodType`** in `apps/whispering/src/lib/services/http/types.ts`:
   - Zod v4 eliminated `ZodTypeAny` in favor of the simpler `ZodType` generic constraint
   - This change affects how generic schema parameters are typed

3. **Removed explicit `headers: undefined`** in `apps/whispering/src/lib/services/transcription/self-hosted/speaches.ts`:
   - With `exactOptionalPropertyTypes: true`, you cannot pass `undefined` to optional properties
   - Simply omitting the property is the correct pattern

### Breaking Changes NOT Encountered

The codebase does not use any of these deprecated Zod v3 patterns:
- `{ message: ... }` error customization (none found)
- `invalid_type_error` or `required_error` parameters (none found)
- `errorMap` parameter (none found)
- `.email()`, `.uuid()`, `.ip()` string validators (none found)
- `.strict()`, `.passthrough()`, `.deepPartial()`, `.merge()` object methods (none found on Zod objects)
- `z.function()` schemas (none found)
- `.format()`, `.flatten()`, `.addIssue()` error methods (none found)

### Pre-existing Issues (Unrelated to Zod)

The following errors appeared during `bun run check` but are NOT related to Zod:

1. **`better-auth/crypto` import error** in `packages/db`:
   - `hashToBase64` is not exported from `better-auth/crypto`
   - This is a dependency version issue, not a Zod issue

2. **wellcrafted error type mismatches**:
   - Several files have `Result` type errors where error objects are missing `context` and `cause` properties
   - This is about the wellcrafted library's error type requirements

3. **`exactOptionalPropertyTypes` issues**:
   - Multiple files have type errors related to passing `undefined` to optional properties
   - This is a TypeScript strictness issue, not Zod-related

### Follow-up: Standard Schema Migration

After the Zod v4 migration, the HTTP service types were updated to use Standard Schema (`@standard-schema/spec`) instead of Zod-specific types. This makes the HTTP service work with any validation library that implements the Standard Schema spec (Zod, Valibot, ArkType, etc.).

**Changes Made:**

1. **Updated `apps/whispering/src/lib/services/http/types.ts`**:
   - Changed import from `import type { z } from 'zod'` to `import type { StandardSchemaV1 } from '@standard-schema/spec'`
   - Changed generic constraint from `z.ZodType` to `StandardSchemaV1`
   - Changed type inference from `z.infer<TSchema>` to `StandardSchemaV1.InferOutput<TSchema>`

2. **Updated `apps/whispering/src/lib/services/http/desktop.ts` and `web.ts`**:
   - Changed from Zod's `schema.parse(json)` to Standard Schema's `schema['~standard'].validate(json)`
   - Added proper error handling for validation issues
   - Added type assertion for the validated value

**Why Standard Schema?**
- Validation library agnostic: works with Zod, Valibot, ArkType, etc.
- Future-proof: can switch validation libraries without changing the HTTP service
- Already a dependency in the project via `@standard-schema/spec`

### Summary

The Zod v4 migration was minimal because the codebase uses Zod in a straightforward way without relying on deprecated features. The initial required code change was updating the generic constraint from `z.ZodTypeAny` to `z.ZodType`, followed by a switch to Standard Schema for better validation library flexibility.
